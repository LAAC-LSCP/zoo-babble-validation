---
title: "SLT_paper"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(caret)

dodiv=function(x) x/sum(x, na.rm=T)

```

```{r}
read.csv("first_class_lisa.csv")->zoon
summary(zoon)

read.csv("Metadata_batch2_lisa.csv",sep="\t")->md
summary(md)
#? correct errors in md? onset           offset       chunk_pos

read.csv("result_final_lisa.csv")->lab
summary(lab)

data_all <- read.csv("final_classifications_PU_zoon.csv")

#remove the word mixed that takes up space and is unnecessary
data_all$Zoon_classif=factor(gsub("Mixed_","",as.character(data_all$Zoon_classif),fixed=T))

data_all$Zoon_classif=factor(data_all$Zoon_classif, levels=c("Canonical","Non-Canonical",
                                                             "Crying","Laughing","Junk",levels(data_all$Zoon_classif)[grep("_",levels(data_all$Zoon_classif))]))


# create lab column with easier to read correspondance
data_all$lab<-as.character(data_all$Major_Choice)
data_all$lab[data_all$lab=="Non-canonical syllables"]<-"Non-Canonical"
data_all$lab[data_all$lab=="Canonical syllables"]<-"Canonical"
data_all$lab[data_all$lab %in% c("Don't mark","None")]<-"Junk"
data_all$lab=factor(data_all$lab,levels=levels(data_all$Zoon_classif))

```



## correspondence
i) quantifying the correspondence between expert human annotations and Zooniverse annotations %(confusion matrix) 
and 

```{r}
table(data_all$lab)
table(data_all$Zoon_classif)

mycf=confusionMatrix(data_all$lab, data_all$Zoon_classif, dnn = c("Lab","Zooniverse"))

conf_tab=mycf$table

# this package uses sensitivity & specificity
#Sensitivity=recall
#Specificity=precision


```

```{r prec}
pdf("precision_with_mixed.pdf",height=10,width=10)
prop_cat=data.frame(conf_tab/colSums(conf_tab)*100) #generates precision because columns
prop_cat$id=paste(prop_cat$Lab,prop_cat$Zooniverse)
colnames(prop_cat)[3]<-"pr"

data.frame(conf_tab)->stall
stall$id=paste(stall$Lab,stall$Zooniverse)
stall=merge(stall,prop_cat[c("id","pr")])



ggplot(data = stall, mapping = aes(y = Lab, x=Zooniverse)) +
 geom_tile(aes(fill= rescale(pr)), colour = "white") +
  geom_text(aes(label = paste(round(pr),"%")), vjust = -1,size=2) +
  geom_text(aes(label = Freq), vjust = 1,size=2) +
  scale_fill_gradient(low = "white", high = "red", name = "Percentage") +
     theme(legend.position = "none") +
  xlab("Zooniverse") + ylab("Lab") +
  ggtitle("Precision")+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
dev.off()
```

```{r recall}
pdf("recall_with_mixed.pdf",height=10,width=10)
prop_cat=data.frame(conf_tab/rowSums(conf_tab)*100)  #generates recall because rows
prop_cat$id=paste(prop_cat$Lab,prop_cat$Zooniverse)
colnames(prop_cat)[3]<-"rec"

data.frame(conf_tab)->stall
stall$id=paste(stall$Lab,stall$Zooniverse)
stall=merge(stall,prop_cat[c("id","rec")])

ggplot(data = stall, mapping = aes(y = Lab, x=Zooniverse)) +
 geom_tile(aes(fill= rescale(rec)), colour = "white") +
  geom_text(aes(label = paste(round(rec),"%")), vjust = -1,size=2) +
  geom_text(aes(label = Freq), vjust = 1,size=2) +
  scale_fill_gradient(low = "white", high = "red", name = "Percentage") +
     theme(legend.position = "none") +
  xlab("Zooniverse") + ylab("Lab") +
  ggtitle("Recall")+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


dev.off()
```

## What is said about infants

ii) examining the correspondences between descriptors at the child level across the two annotation settings (e.g. CR-AGE correlations).

```{r by child}

#given results above, we map the mixed
data_all$Zoon_classif[data_all$Zoon_classif=="Laughing_Canonical"]<-"Canonical"
data_all$Zoon_classif[data_all$Zoon_classif=="Laughing_Non-Canonical"]<-"Non-Canonical"
data_all$Zoon_classif[data_all$Zoon_classif=="Laughing_Non-Canonical_Crying"]<-"Non-Canonical"
data_all$Zoon_classif[data_all$Zoon_classif=="Laughing_Crying"]<-"Crying"
data_all$Zoon_classif[data_all$Zoon_classif=="Non-Canonical_Crying"]<-"Non-Canonical"
data_all$Zoon_classif[data_all$Zoon_classif=="Non-Canonical_Laughing_Crying"]<-"Non-Canonical"

#and reset the factors for cleanliness
data_all$Zoon_classif=factor(data_all$Zoon_classif)
data_all$lab=factor(data_all$lab)

zoon_sums = data_all %>% group_by(ChildID,Zoon_classif) %>% tally()
colnames(zoon_sums)<-c("ChildID",      "Zoon_classif", "n_zoo")
lab_sums = data_all %>% group_by(ChildID,lab) %>% tally()
zoon_sums$id=paste(zoon_sums$ChildID,zoon_sums$Zoon_classif)
lab_sums$id=paste(lab_sums$ChildID,lab_sums$lab)
sums=merge(zoon_sums,lab_sums[,c("lab" ,  "n", "id")],by="id",all=T)

```



# Canonical Rate analysis by Age & ChildID

```{r CR by Age}
df.sub <- subset(data_all, Zoon_classif %in% c("Canonical","Non-Canonical"))

### By Age
n.can <- as.data.frame(df.sub %>% group_by(Age) %>% filter(Zoon_classif == "Canonical") %>% summarise(n.can = n()))
n.non.can <- as.data.frame(df.sub %>% group_by(Age) %>% filter(Zoon_classif == "Non-Canonical") %>% summarise(n.non.can = n()))
n.tot <- merge(n.can, n.non.can)
n.tot$ratio.can <- n.tot$n.can/(n.tot$n.can + n.tot$n.non.can)
n.tot$ratio.non.can <- n.tot$n.non.can/(n.tot$n.can + n.tot$n.non.can)

### CANONICAL
df.plot <- rbind(data.frame(Age = as.factor(n.tot$Age), Ratio = n.tot$ratio.can, Cat = "Canonical"))
ggplot(df.plot, aes(fill=Cat, y=Ratio, x=Age)) + 
  geom_bar(position="dodge", stat="identity")

### NONCANONICAL
df.plot <- rbind(data.frame(Age = as.factor(n.tot$Age), Ratio = n.tot$ratio.non.can, Cat = "Non-Canonical"))
ggplot(df.plot, aes(fill=Cat, y=Ratio, x=Age)) + 
  geom_bar(position="dodge", stat="identity")

###BOTH

df.plot <- rbind(data.frame(Age = as.factor(n.tot$Age), Ratio = n.tot$ratio.can, Cat = "Canonical"),data.frame(Age = as.factor(n.tot$Age), Ratio = n.tot$ratio.non.can, Cat = "Non-canonical"))

ggplot(df.plot, aes(fill=Cat, y=Ratio, x=Age)) + 
  geom_bar(position="dodge", stat="identity")
```

```{r ChildID}
### By Recording (=Child ID)
n.can <- as.data.frame(df.sub %>% group_by(ChildID) %>% filter(Zoon_classif == "Canonical") %>% summarise(n.can = n()))
n.non.can <- as.data.frame(df.sub %>% group_by(ChildID) %>% filter(Zoon_classif == "Non-Canonical") %>% summarise(n.non.can = n()))
n.tot <- merge(n.can, n.non.can)
n.tot$ratio.can <- n.tot$n.can/(n.tot$n.can + n.tot$n.non.can)
n.tot$ratio.non.can <- n.tot$n.non.can/(n.tot$n.can + n.tot$n.non.can)
df.plot <- rbind(data.frame(ChildID = as.factor(n.tot$ChildID), Ratio = n.tot$ratio.can, Cat = "Canonical"),
                 data.frame(ChildID = as.factor(n.tot$ChildID), Ratio = n.tot$ratio.non.can, Cat = "Non-Canonical"))

ggplot(df.plot, aes(fill=Cat, y=Ratio, x=ChildID)) + 
  geom_bar(position="dodge", stat="identity")
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
